<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp School Communication System - Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .dashboard {
            padding: 30px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #25D366;
        }
        
        .status-card h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status-value {
            font-size: 2em;
            font-weight: bold;
            color: #25D366;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #25D366;
            padding-bottom: 10px;
        }
        
        .test-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .test-btn {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }
        
        .test-btn:active {
            transform: translateY(0);
        }
        
        .results {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .message-format {
            background: #e8f5e8;
            border: 1px solid #25D366;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-line;
        }
        
        .log-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .log-entry.success {
            background: #d4edda;
            color: #155724;
        }
        
        .log-entry.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log-entry.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #25D366;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tabs {
            display: flex;
            background: #f1f1f1;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.3s;
        }
        
        .tab.active {
            background: #25D366;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“± WhatsApp School Communication System</h1>
            <p>Test Dashboard - Monitor and Test Your System</p>
        </div>
        
        <div class="dashboard">
            <!-- System Status -->
            <div class="status-grid" id="statusGrid">
                <div class="status-card">
                    <h3>System Status</h3>
                    <div class="status-value" id="systemStatus">Loading...</div>
                </div>
                <div class="status-card">
                    <h3>Total Messages</h3>
                    <div class="status-value" id="totalMessages">0</div>
                </div>
                <div class="status-card">
                    <h3>Teachers</h3>
                    <div class="status-value" id="totalTeachers">0</div>
                </div>
                <div class="status-card">
                    <h3>Parents</h3>
                    <div class="status-value" id="totalParents">0</div>
                </div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="showTab('test')">ğŸ§ª Test Messages</div>
                <div class="tab" onclick="showTab('monitor')">ğŸ“Š Monitor System</div>
                <div class="tab" onclick="showTab('messages')">ğŸ’¬ Recent Messages</div>
                <div class="tab" onclick="showTab('help')">â“ Help & Formats</div>
            </div>
            
            <!-- Test Messages Tab -->
            <div class="tab-content active" id="testTab">
                <div class="test-section">
                    <h2>ğŸ§‘â€ğŸ« Test Teacher Messages</h2>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testTeacherUpdate()">ğŸ“š Send Daily Update</button>
                        <button class="test-btn" onclick="testAttendance()">ğŸ“… Send Attendance</button>
                        <button class="test-btn" onclick="testInvalidTeacher()">âŒ Test Invalid Format</button>
                    </div>
                </div>
                
                <div class="test-section">
                    <h2>ğŸ‘¨â€ğŸ’¼ Test Admin Messages</h2>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testAnnouncement()">ğŸ“¢ Send Announcement</button>
                        <button class="test-btn" onclick="testHolidayNotice()">ğŸ–ï¸ Send Holiday Notice</button>
                        <button class="test-btn" onclick="testInvalidAdmin()">âŒ Test Invalid Admin</button>
                    </div>
                </div>
                
                <div class="test-section">
                    <h2>ğŸ”§ System Tests</h2>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="testWebhook()">ğŸ”— Test Webhook</button>
                        <button class="test-btn" onclick="testHealth()">ğŸ’š Check Health</button>
                        <button class="test-btn" onclick="clearLogs()">ğŸ—‘ï¸ Clear Logs</button>
                    </div>
                </div>
                
                <div class="results" id="testResults">
                    <div class="log-entry info">Ready to test! Click any button above to simulate WhatsApp messages.</div>
                </div>
            </div>
            
            <!-- Monitor Tab -->
            <div class="tab-content" id="monitorTab">
                <div class="test-section">
                    <h2>ğŸ“Š System Monitoring</h2>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="refreshStats()">ğŸ”„ Refresh Stats</button>
                        <button class="test-btn" onclick="checkWhatsAppStatus()">ğŸ“± WhatsApp Status</button>
                        <button class="test-btn" onclick="viewSystemInfo()">â„¹ï¸ System Info</button>
                    </div>
                    <div class="results" id="monitorResults">
                        <div class="log-entry info">Click "Refresh Stats" to see current system status.</div>
                    </div>
                </div>
            </div>
            
            <!-- Messages Tab -->
            <div class="tab-content" id="messagesTab">
                <div class="test-section">
                    <h2>ğŸ’¬ Recent Messages</h2>
                    <div class="test-buttons">
                        <button class="test-btn" onclick="loadRecentMessages()">ğŸ“¥ Load Messages</button>
                        <button class="test-btn" onclick="filterByType('daily_update')">ğŸ“š Daily Updates</button>
                        <button class="test-btn" onclick="filterByType('announcement')">ğŸ“¢ Announcements</button>
                        <button class="test-btn" onclick="filterByType('attendance')">ğŸ“… Attendance</button>
                    </div>
                    <div class="results" id="messagesResults">
                        <div class="log-entry info">Click "Load Messages" to see processed messages.</div>
                    </div>
                </div>
            </div>
            
            <!-- Help Tab -->
            <div class="tab-content" id="helpTab">
                <div class="test-section">
                    <h2>ğŸ“ Message Formats</h2>
                    
                    <h3>ğŸ§‘â€ğŸ« Teacher Daily Update Format:</h3>
                    <div class="message-format">Class: Grade 5A
Subject: Mathematics
Topic: Addition and Subtraction
Homework: Complete exercises 1-10 on page 25
Understanding: Good</div>
                    
                    <h3>ğŸ“… Teacher Attendance Format:</h3>
                    <div class="message-format">Attendance: P,P,A,P,P</div>
                    
                    <h3>ğŸ“¢ Admin Announcement Format:</h3>
                    <div class="message-format">Announcement: School Holiday
Message: Tomorrow is a public holiday. School will be closed.</div>
                    
                    <h3>ğŸ“± Your WhatsApp Setup:</h3>
                    <div class="message-format">Test Number: +1 555 145 3997
Phone Number ID: 992612663930736
Verify Token: school_webhook_2024_secure
Webhook URL: https://school-comm-system.onrender.com/webhook</div>
                </div>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing...</p>
            </div>
        </div>
    </div>

    <script>
        // Base URL for API calls
        const API_BASE = window.location.origin;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadSystemStatus();
            setInterval(loadSystemStatus, 30000); // Refresh every 30 seconds
        });
        
        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Load system status
        async function loadSystemStatus() {
            try {
                const [healthResponse, statsResponse] = await Promise.all([
                    fetch(`${API_BASE}/health`),
                    fetch(`${API_BASE}/api/stats`)
                ]);
                
                const health = await healthResponse.json();
                const stats = await statsResponse.json();
                
                document.getElementById('systemStatus').textContent = health.status;
                document.getElementById('totalMessages').textContent = stats.messages || 0;
                document.getElementById('totalTeachers').textContent = stats.teachers || 0;
                document.getElementById('totalParents').textContent = stats.parents || 0;
                
            } catch (error) {
                console.error('Error loading status:', error);
                document.getElementById('systemStatus').textContent = 'Error';
            }
        }
        
        // Simulate WhatsApp message processing
        async function simulateMessage(senderNumber, messageText, description) {
            showLoading(true);
            addLog('info', `ğŸ§ª Testing: ${description}`);
            addLog('info', `ğŸ“± From: ${senderNumber}`);
            addLog('info', `ğŸ’¬ Message: ${messageText}`);
            
            try {
                // Simulate the webhook call
                const response = await fetch(`${API_BASE}/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        object: 'whatsapp_business_account',
                        entry: [{
                            changes: [{
                                value: {
                                    messages: [{
                                        from: senderNumber,
                                        type: 'text',
                                        text: {
                                            body: messageText
                                        }
                                    }]
                                }
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    addLog('success', 'âœ… Message processed successfully!');
                    
                    // Load recent messages to show the result
                    setTimeout(async () => {
                        const messagesResponse = await fetch(`${API_BASE}/api/messages?limit=1`);
                        const messagesData = await messagesResponse.json();
                        
                        if (messagesData.messages && messagesData.messages.length > 0) {
                            const latestMessage = messagesData.messages[0];
                            addLog('success', `ğŸ“Š Result: ${JSON.stringify(latestMessage, null, 2)}`);
                        }
                        
                        loadSystemStatus(); // Refresh stats
                    }, 1000);
                } else {
                    addLog('error', 'âŒ Failed to process message');
                }
            } catch (error) {
                addLog('error', `âŒ Error: ${error.message}`);
            }
            
            showLoading(false);
        }
        
        // Test functions
        function testTeacherUpdate() {
            const message = `Class: Grade 5A
Subject: Mathematics
Topic: Addition and Subtraction of 3-digit numbers
Homework: Complete exercises 1-10 on page 25
Understanding: Good`;
            simulateMessage('+15551453997', message, 'Teacher Daily Update');
        }
        
        function testAttendance() {
            simulateMessage('+15551453997', 'Attendance: P,A', 'Teacher Attendance');
        }
        
        function testAnnouncement() {
            const message = `Announcement: School Holiday Notice
Message: Tomorrow is a public holiday due to Dashain festival. School will be closed. Regular classes will resume on Monday.`;
            simulateMessage('+15551453997', message, 'Admin Announcement');
        }
        
        function testHolidayNotice() {
            const message = `Announcement: Parent-Teacher Meeting
Message: Parent-teacher meeting is scheduled for next Friday at 2 PM. Please confirm your attendance.`;
            simulateMessage('+15551453997', message, 'Holiday Notice');
        }
        
        function testInvalidTeacher() {
            simulateMessage('+15551453997', 'This is not a valid format', 'Invalid Message Format');
        }
        
        function testInvalidAdmin() {
            simulateMessage('+19999999999', 'Class: Test', 'Unregistered User');
        }
        
        async function testWebhook() {
            showLoading(true);
            addLog('info', 'ğŸ”— Testing webhook verification...');
            
            try {
                const response = await fetch(`${API_BASE}/webhook?hub.mode=subscribe&hub.verify_token=school_webhook_2024_secure&hub.challenge=test123`);
                const result = await response.text();
                
                if (result === 'test123') {
                    addLog('success', 'âœ… Webhook verification successful!');
                } else {
                    addLog('error', `âŒ Webhook verification failed. Got: ${result}`);
                }
            } catch (error) {
                addLog('error', `âŒ Webhook test error: ${error.message}`);
            }
            
            showLoading(false);
        }
        
        async function testHealth() {
            showLoading(true);
            addLog('info', 'ğŸ’š Checking system health...');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const health = await response.json();
                
                addLog('success', `âœ… System Status: ${health.status}`);
                addLog('info', `ğŸ“Š Uptime: ${health.uptime} seconds`);
                addLog('info', `ğŸ’¾ Memory: ${health.memory.used} / ${health.memory.total}`);
                addLog('info', `ğŸ”§ Components: ${JSON.stringify(health.components, null, 2)}`);
            } catch (error) {
                addLog('error', `âŒ Health check error: ${error.message}`);
            }
            
            showLoading(false);
        }
        
        async function refreshStats() {
            showLoading(true);
            addLog('info', 'ğŸ“Š Refreshing system statistics...');
            
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                const stats = await response.json();
                
                const resultsDiv = document.getElementById('monitorResults');
                resultsDiv.innerHTML = `
                    <div class="log-entry success">ğŸ“Š System Statistics (Updated: ${new Date().toLocaleTimeString()})</div>
                    <div class="log-entry info">ğŸ« Schools: ${stats.schools}</div>
                    <div class="log-entry info">ğŸ‘¨â€ğŸ« Teachers: ${stats.teachers}</div>
                    <div class="log-entry info">ğŸ‘¨â€ğŸ’¼ Admins: ${stats.admins}</div>
                    <div class="log-entry info">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Parents: ${stats.parents}</div>
                    <div class="log-entry info">ğŸ‘¦ğŸ‘§ Students: ${stats.students}</div>
                    <div class="log-entry info">ğŸ’¬ Total Messages: ${stats.messages}</div>
                    <div class="log-entry info">ğŸ“š Daily Updates: ${stats.messagesByType.daily_update}</div>
                    <div class="log-entry info">ğŸ“… Attendance Records: ${stats.messagesByType.attendance}</div>
                    <div class="log-entry info">ğŸ“¢ Announcements: ${stats.messagesByType.announcement}</div>
                `;
                
                loadSystemStatus(); // Update header stats
            } catch (error) {
                addLog('error', `âŒ Stats error: ${error.message}`);
            }
            
            showLoading(false);
        }
        
        async function checkWhatsAppStatus() {
            showLoading(true);
            addLog('info', 'ğŸ“± Checking WhatsApp integration status...');
            
            try {
                const response = await fetch(`${API_BASE}/`);
                const info = await response.json();
                
                const resultsDiv = document.getElementById('monitorResults');
                resultsDiv.innerHTML = `
                    <div class="log-entry success">ğŸ“± WhatsApp Integration Status</div>
                    <div class="log-entry info">ğŸ”§ Status: ${JSON.stringify(info.whatsappStatus, null, 2)}</div>
                    <div class="log-entry info">ğŸ“Š Features: ${info.features.join(', ')}</div>
                    <div class="log-entry info">ğŸ“ˆ Version: ${info.version}</div>
                `;
            } catch (error) {
                addLog('error', `âŒ WhatsApp status error: ${error.message}`);
            }
            
            showLoading(false);
        }
        
        async function viewSystemInfo() {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/`);
                const info = await response.json();
                
                const resultsDiv = document.getElementById('monitorResults');
                resultsDiv.innerHTML = `
                    <div class="log-entry success">â„¹ï¸ Complete System Information</div>
                    <div class="log-entry info"><pre>${JSON.stringify(info, null, 2)}</pre></div>
                `;
            } catch (error) {
                addLog('error', `âŒ System info error: ${error.message}`);
            }
            
            showLoading(false);
        }
        
        async function loadRecentMessages() {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/api/messages?limit=10`);
                const data = await response.json();
                
                const resultsDiv = document.getElementById('messagesResults');
                resultsDiv.innerHTML = '<div class="log-entry success">ğŸ“¥ Recent Messages</div>';
                
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        const typeIcon = msg.type === 'daily_update' ? 'ğŸ“š' : 
                                       msg.type === 'announcement' ? 'ğŸ“¢' : 
                                       msg.type === 'attendance' ? 'ğŸ“…' : 'ğŸ’¬';
                        
                        resultsDiv.innerHTML += `
                            <div class="log-entry info">
                                ${typeIcon} ${msg.type.toUpperCase()} - ${msg.timestamp}<br>
                                <pre>${JSON.stringify(msg.content, null, 2)}</pre>
                            </div>
                        `;
                    });
                } else {
                    resultsDiv.innerHTML += '<div class="log-entry info">No messages found. Send some test messages first!</div>';
                }
            } catch (error) {
                addLog('error', `âŒ Messages error: ${error.message}`);
            }
            
            showLoading(false);
        }
        
        async function filterByType(type) {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE}/api/messages?limit=20`);
                const data = await response.json();
                
                const filteredMessages = data.messages.filter(msg => msg.type === type);
                
                const resultsDiv = document.getElementById('messagesResults');
                resultsDiv.innerHTML = `<div class="log-entry success">ğŸ“¥ ${type.toUpperCase()} Messages (${filteredMessages.length})</div>`;
                
                if (filteredMessages.length > 0) {
                    filteredMessages.forEach(msg => {
                        const typeIcon = type === 'daily_update' ? 'ğŸ“š' : 
                                       type === 'announcement' ? 'ğŸ“¢' : 
                                       type === 'attendance' ? 'ğŸ“…' : 'ğŸ’¬';
                        
                        resultsDiv.innerHTML += `
                            <div class="log-entry info">
                                ${typeIcon} ${msg.timestamp}<br>
                                <pre>${JSON.stringify(msg.content, null, 2)}</pre>
                            </div>
                        `;
                    });
                } else {
                    resultsDiv.innerHTML += `<div class="log-entry info">No ${type} messages found.</div>`;
                }
            } catch (error) {
                addLog('error', `âŒ Filter error: ${error.message}`);
            }
            
            showLoading(false);
        }
        
        function clearLogs() {
            document.getElementById('testResults').innerHTML = '<div class="log-entry info">Logs cleared. Ready for new tests!</div>';
        }
        
        // Utility functions
        function addLog(type, message) {
            const resultsDiv = document.getElementById('testResults');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(logEntry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>